<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeBox - 极简的待办事项管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* 自定义动画和过渡效果 - 优化版本 */
        @keyframes slideIn {
            from { opacity: 0; transform: translate3d(0, -10px, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translate3d(100px, 0, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.25s ease-out;
            will-change: transform, opacity;
        }

        .slide-in-right {
            animation: slideInRight 0.25s ease-out;
            will-change: transform, opacity;
        }

        .fade-in {
            animation: fadeIn 0.25s ease-out;
            will-change: opacity;
        }

        .task-item {
            transition: transform 0.2s ease, opacity 0.2s ease;
            will-change: transform;
        }

        .task-item:hover {
            transform: translate3d(5px, 0, 0);
        }

        /* 通知和模态框动画优化 */
        .notification, .modal-backdrop {
            will-change: transform, opacity;
            transform: translate3d(0, 0, 0);
        }

        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }
        .priority-none { border-left: 4px solid #e5e7eb; }

        .completed {
            opacity: 0.7;
            background-color: #f9fafb;
        }

        .completed .task-title {
            text-decoration: line-through;
            color: #9ca3af;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 模态框背景 */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        /* 响应式网格布局 */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* 深色主题样式 */
        .dark {
            background-color: #0f1419 !important;
            color: #e5e5e5;
        }

        body.dark {
            background-color: #0f1419 !important;
        }

        .dark .bg-white {
            background-color: #1e242b !important;
        }

        .dark .bg-gray-50 {
            background-color: #0f1419 !important;
        }

        .dark .bg-gray-100 {
            background-color: #2c3139 !important;
        }

        .dark .bg-gray-200 {
            background-color: #3a4049 !important;
        }

        .dark .text-gray-800 {
            color: #f7f9fa !important;
        }

        .dark .text-gray-700 {
            color: #e1e6ea !important;
        }

        .dark .text-gray-600 {
            color: #b8c5d1 !important;
        }

        .dark .text-gray-500 {
            color: #8899a6 !important;
        }

        .dark .text-gray-400 {
            color: #657786 !important;
        }

        .dark .text-gray-900 {
            color: #ffffff !important;
        }

        .dark .border-gray-200 {
            border-color: #38444d !important;
        }

        .dark .border-gray-300 {
            border-color: #2c3139 !important;
        }

        .dark .border-red-200 {
            border-color: #b84343 !important;
        }

        .dark .border-blue-200 {
            border-color: #4c9eda !important;
        }
        .dark .task-item {
            border-color: #374151 !important;
        }

        .dark .hover\:bg-gray-50:hover {
            background-color: #2c3139 !important;
        }

        .dark .hover\:bg-gray-100:hover {
            background-color: #38444d !important;
        }

        .dark .hover\:bg-gray-200:hover {
            background-color: #4a5568 !important;
        }

        .dark .hover\:text-blue-600:hover {
            color: #4c9eda !important;
        }

        .dark .hover\:text-green-600:hover {
            color: #34d399 !important;
        }

        .dark .hover\:text-red-600:hover {
            color: #f87171 !important;
        }

        .dark .hover\:text-yellow-600:hover {
            color: #fbbf24 !important;
        }

        /* 深色主题滚动条 */
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #2c3139;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #657786;
        }

        /* 深色主题输入框 */
        .dark input, .dark textarea, .dark select {
            background-color: #2c3139 !important;
            color: #f7f9fa !important;
            border-color: #38444d !important;
        }

        .dark input:focus, .dark textarea:focus, .dark select:focus {
            border-color: #4c9eda !important;
            box-shadow: 0 0 0 1px #4c9eda !important;
        }

        /* 深色主题模态框 */
        .dark .modal-backdrop {
            background-color: rgba(15, 20, 25, 0.8) !important;
        }

        /* 深色主题进度条背景 */
        .dark .bg-gray-200 {
            background-color: #3a4049 !important;
        }

        /* 深色主题下拉菜单 */
        .dark .absolute.bg-white.shadow-lg {
            background-color: #1e242b !important;
            border: 1px solid #38444d !important;
        }

        /* 深色主题阴影 */
        .dark .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3) !important;
        }

        .dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
        }

        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3) !important;
        }

        .dark .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4) !important;
        }

        /* 深色主题日历 */
        .dark .calendar-day {
            background-color: #2c3139 !important;
        }

        .dark .calendar-day.selected {
            background-color: #4c9eda !important;
        }

        /* 深色主题页脚链接 */
        .dark footer a {
            color: #8899a6 !important;
        }

        .dark footer a:hover {
            color: #4c9eda !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 头部导航 -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-cube text-blue-600 text-2xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">TimeBox</h1>
                        <p class="text-xs text-gray-500">极简的待办事项管理</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="text-gray-600 hover:text-yellow-600 transition-colors" title="切换主题">
                        <i class="fas fa-moon text-xl" id="themeIcon"></i>
                    </button>
                    <button id="statsBtn" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-chart-bar text-xl"></i>
                    </button>
                    <button id="helpBtn" class="text-gray-600 hover:text-green-600 transition-colors" title="操作提示">
                        <i class="fas fa-question-circle text-xl"></i>
                    </button>
                    <button id="trashBtn" class="text-gray-600 hover:text-red-600 transition-colors relative">
                        <i class="fas fa-trash text-xl"></i>
                        <span id="trashCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <a href="https://mozhix.top" target="_blank" class="text-gray-600 hover:text-blue-600 transition-colors" title="回到主页">
                        <i class="fas fa-home text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- 主容器 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- 统计信息栏 -->
        <div class="bg-white rounded-lg shadow-md p-2 mb-6 fade-in">
            <!-- 总进度条容器 -->
            <div class="relative w-full h-8 bg-gray-200 rounded-md overflow-hidden">
                <!-- 背景文字 -->
                <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                    <span class="text-sm text-black font-medium">总任务: <span id="totalTasksBg">0</span> | 已完成: <span id="completedTasksBg">0</span> | 进行中: <span id="pendingTasksBg">0</span> | <span id="progressTextBg">0%</span></span>
                </div>
                <!-- 已完成进度条 -->
                <div id="progressBar" class="absolute top-0 left-0 h-full bg-blue-600 transition-all duration-300" style="width: 0%">
                </div>
                <!-- 进度条内文字 -->
                <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center pointer-events-none">
                    <span id="progressBarText" class="text-sm text-black font-medium" style="display: none;">总任务: <span id="totalTasks">0</span> | 已完成: <span id="completedTasks">0</span> | 进行中: <span id="pendingTasks">0</span> | <span id="progressText">0%</span></span>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="main-grid">
            <!-- 左侧：任务添加/编辑区域 -->
            <div class="bg-white rounded-lg shadow-md p-5">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-plus-circle text-blue-600 mr-2"></i>
                    <span id="formTitle">添加新任务</span>
                </h2>

                <form id="taskForm" class="space-y-4">
                    <input type="hidden" id="editingTaskId" value="">

                    <div>
                        <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-1">
                            任务标题 <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="taskTitle"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="输入任务标题..."
                        >
                    </div>

                    <div>
                        <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">
                            任务描述
                        </label>
                        <textarea
                            id="taskDescription"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                            placeholder="输入任务描述（可选）..."
                        ></textarea>
                    </div>

                    <div>
                        <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-1">
                            优先级
                        </label>
                        <select
                            id="taskPriority"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="none">无优先级</option>
                            <option value="low">低优先级</option>
                            <option value="medium" selected>中优先级</option>
                            <option value="high">高优先级</option>
                        </select>
                    </div>

                    <div>
                        <label for="taskDeadline" class="block text-sm font-medium text-gray-700 mb-1">
                            截止日期时间
                        </label>
                        <input
                            type="datetime-local"
                            id="taskDeadline"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>

                    <div class="flex space-x-3">
                        <button
                            type="submit"
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center"
                        >
                            <i class="fas fa-save mr-2"></i>
                            <span id="submitBtnText">添加任务</span>
                        </button>
                        <button
                            type="button"
                            id="cancelEditBtn"
                            class="hidden px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors duration-200"
                        >
                            取消
                        </button>
                    </div>
                </form>
            </div>

            <!-- 右侧：任务列表区域 -->
            <div class="bg-white rounded-lg shadow-md p-5 flex flex-col">
                <!-- 搜索和过滤区域 -->
                <div class="mb-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="relative flex-1 mr-4">
                            <input
                                type="text"
                                id="searchInput"
                                class="w-full pl-10 pr-4 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="搜索任务..."
                            >
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="selectAllBtn" class="hidden px-3 py-2 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200 transition-colors">
                                <i class="fas fa-check-square mr-1"></i>
                                全选
                            </button>
                            <button id="batchDeleteBtn" class="hidden px-3 py-2 bg-red-100 text-red-700 rounded-md text-sm hover:bg-red-200 transition-colors">
                                <i class="fas fa-trash mr-1"></i>
                                批量删除
                            </button>
                            <button id="toggleBatchModeBtn" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-md text-sm hover:bg-gray-200 transition-colors">
                                <i class="fas fa-tasks mr-1"></i>
                                批量操作
                            </button>
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button class="filter-btn active px-3 py-1.5 rounded-md text-sm font-medium transition-colors" data-filter="all">
                            全部任务
                        </button>
                        <button class="filter-btn px-3 py-1.5 rounded-md text-sm font-medium transition-colors" data-filter="pending">
                            未完成
                        </button>
                        <button class="filter-btn px-3 py-1.5 rounded-md text-sm font-medium transition-colors" data-filter="completed">
                            已完成
                        </button>
                    </div>
                </div>

                <!-- 任务列表容器 -->
                <div id="taskList" class="space-y-3 overflow-y-auto pr-2 flex-1" style="max-height: calc(100vh - 280px); min-height: 450px;">
                    <!-- 任务项将在这里动态生成 -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>暂无任务，开始添加您的第一个任务吧！</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

      <!-- 底部链接 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-2 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-center space-x-8">
                <a href="https://mozhix.top" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-blue-600 transition-colors text-sm font-medium">
                    MoZhi
                </a>
                <a href="https://github.com/mozhi-it/TimeBox" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-blue-600 transition-colors text-sm inline-flex items-center">
                    <i class="fab fa-github mr-1"></i>
                    TimeBox
                </a>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div id="confirmModal" class="fixed inset-0 z-[60] hidden">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 slide-in">
                <h3 class="text-lg font-semibold text-gray-900 mb-3" id="confirmTitle">确认操作</h3>
                <p class="text-gray-600 mb-6" id="confirmMessage">您确定要执行此操作吗？</p>
                <div class="flex space-x-3 justify-end">
                    <button id="confirmCancel" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button id="confirmOk" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed top-4 right-4 z-[70] hidden">
        <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-sm slide-in-right">
            <div class="flex items-center">
                <i id="notificationIcon" class="text-xl mr-3"></i>
                <div>
                    <p id="notificationMessage" class="text-gray-800 font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助提示模态框 -->
    <div id="helpModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto slide-in">
                <!-- 帮助头部 -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-question-circle text-green-600 text-xl"></i>
                        <h2 class="text-xl font-semibold text-gray-900">操作提示</h2>
                    </div>
                    <button id="closeHelpBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- 帮助内容 -->
                <div class="p-6 space-y-6">
                    <!-- 基本操作 -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-basics text-blue-600 mr-2"></i>基本操作
                        </h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start">
                                <i class="fas fa-plus text-green-500 mr-2 mt-1"></i>
                                <span><strong>添加任务：</strong>填写左侧表单，设置标题、描述、优先级和截止日期</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-blue-500 mr-2 mt-1"></i>
                                <span><strong>完成任务：</strong>点击任务前的复选框标记任务完成</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-edit text-yellow-500 mr-2 mt-1"></i>
                                <span><strong>编辑任务：</strong>点击任务右侧的编辑按钮修改任务信息</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-trash text-red-500 mr-2 mt-1"></i>
                                <span><strong>删除任务：</strong>点击删除按钮将任务移至回收站</span>
                            </li>
                        </ul>
                    </div>

  
                    <!-- 优先级和截止日期 -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-flag text-blue-600 mr-2"></i>优先级和截止日期
                        </h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-2">
                                    <i class="fas fa-flag mr-1"></i>高
                                </span>
                                <span><strong>高优先级：</strong>重要且紧急的任务</span>
                            </li>
                            <li class="flex items-start">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 mr-2">
                                    <i class="fas fa-flag mr-1"></i>中
                                </span>
                                <span><strong>中优先级：</strong>一般重要的任务</span>
                            </li>
                            <li class="flex items-start">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">
                                    <i class="fas fa-flag mr-1"></i>低
                                </span>
                                <span><strong>低优先级：</strong>不紧急的任务</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-clock text-purple-500 mr-2 mt-1"></i>
                                <span><strong>截止日期：</strong>任务会按截止日期排序，过期任务会特别标注</span>
                            </li>
                        </ul>
                    </div>

                    <!-- 回收站 -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-trash text-blue-600 mr-2"></i>回收站
                        </h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start">
                                <i class="fas fa-recycle text-orange-500 mr-2 mt-1"></i>
                                <span><strong>任务恢复：</strong>删除的任务可在回收站中恢复</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-times-circle text-red-500 mr-2 mt-1"></i>
                                <span><strong>永久删除：</strong>在回收站中可以永久删除任务</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-hourglass-half text-yellow-500 mr-2 mt-1"></i>
                                <span><strong>自动清理：</strong>回收站中的任务将在30天后自动清理</span>
                            </li>
                        </ul>
                    </div>

                    <!-- 快捷键 -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-keyboard text-blue-600 mr-2"></i>快捷操作
                        </h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start">
                                <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-300 rounded mr-2">ESC</kbd>
                                <span>关闭弹窗</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 回收站模态框 -->
    <div id="trashModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col slide-in">
                <!-- 回收站头部 -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-trash text-red-600 text-xl"></i>
                        <h2 class="text-xl font-semibold text-gray-900">回收站</h2>
                        <span id="trashItemCount" class="bg-red-100 text-red-800 text-sm px-2 py-1 rounded-full">0 个项目</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="emptyTrashBtn" class="text-red-600 hover:text-red-800 transition-colors text-sm font-medium">
                            <i class="fas fa-trash-alt mr-1"></i>
                            清空回收站
                        </button>
                        <button id="closeTrashBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- 回收站内容 -->
                <div class="flex-1 overflow-hidden">
                    <div id="trashList" class="h-full overflow-y-auto p-6 space-y-3 max-h-96">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-trash-alt text-5xl mb-4 opacity-50"></i>
                            <p class="text-lg">回收站是空的</p>
                            <p class="text-sm mt-2">删除的任务会出现在这里，并在30天后自动清理</p>
                        </div>
                    </div>
                </div>

                <!-- 回收站底部信息 -->
                <div class="p-4 border-t border-gray-200 bg-gray-50">
                    <p class="text-sm text-gray-600 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        回收站中的项目将在30天后自动永久删除
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 应用程序状态管理
        const AppState = {
            tasks: [],
            deletedTasks: [],
            currentFilter: 'all',
            searchTerm: '',
            editingTask: null,
            batchMode: false,
            selectedTasks: new Set(),
            darkMode: false,

            // 从localStorage加载数据
            loadData() {
                const savedTasks = localStorage.getItem('tasks');
                const savedDeletedTasks = localStorage.getItem('deletedTasks');
                const savedTheme = localStorage.getItem('darkMode');

                if (savedTasks) {
                    this.tasks = JSON.parse(savedTasks);
                }

                if (savedDeletedTasks) {
                    this.deletedTasks = JSON.parse(savedDeletedTasks);
                }

                if (savedTheme) {
                    this.darkMode = savedTheme === 'true';
                }

                // 自动清理过期回收站项目
                this.cleanExpiredDeletedTasks();
            },

            // 保存数据到localStorage
            saveData() {
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                localStorage.setItem('deletedTasks', JSON.stringify(this.deletedTasks));
                localStorage.setItem('darkMode', this.darkMode.toString());
            },

            // 清理超过30天的回收站项目
            cleanExpiredDeletedTasks() {
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                this.deletedTasks = this.deletedTasks.filter(task => task.deletedAt > thirtyDaysAgo);
                this.saveData();
            },

            // 生成唯一ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },

            // 添加任务
            addTask(taskData) {
                const task = {
                    id: this.generateId(),
                    ...taskData,
                    completed: false,
                    createdAt: Date.now(),
                    completedAt: null
                };

                this.tasks.unshift(task);
                this.saveData();
                return task;
            },

            // 更新任务
            updateTask(id, updates) {
                const index = this.tasks.findIndex(task => task.id === id);
                if (index !== -1) {
                    this.tasks[index] = { ...this.tasks[index], ...updates };
                    this.saveData();
                    return this.tasks[index];
                }
                return null;
            },

            // 删除任务
            deleteTask(id) {
                const index = this.tasks.findIndex(task => task.id === id);
                if (index !== -1) {
                    const task = this.tasks[index];
                    task.deletedAt = Date.now();
                    this.deletedTasks.push(task);
                    this.tasks.splice(index, 1);
                    this.saveData();
                    return true;
                }
                return false;
            },

            // 切换任务完成状态
            toggleTask(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    task.completedAt = task.completed ? Date.now() : null;
                    this.saveData();
                    return task;
                }
                return null;
            },

            // 获取过滤后的任务
            getFilteredTasks() {
                let filtered = [...this.tasks];

                // 按状态过滤
                if (this.currentFilter === 'completed') {
                    filtered = filtered.filter(task => task.completed);
                } else if (this.currentFilter === 'pending') {
                    filtered = filtered.filter(task => !task.completed);
                }

                // 按搜索词过滤
                if (this.searchTerm) {
                    const term = this.searchTerm.toLowerCase();
                    filtered = filtered.filter(task =>
                        task.title.toLowerCase().includes(term) ||
                        (task.description && task.description.toLowerCase().includes(term))
                    );
                }

                // 排序
                filtered.sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1, none: 0 };

                    // 优先级排序
                    const priorityDiff = priorityOrder[b.priority] - priorityOrder[a.priority];
                    if (priorityDiff !== 0) return priorityDiff;

                    // 截止日期排序
                    if (!a.completed && !b.completed && a.deadline && b.deadline) {
                        return new Date(a.deadline) - new Date(b.deadline);
                    }

                    // 创建时间排序
                    return b.createdAt - a.createdAt;
                });

                return filtered;
            },

            // 获取任务统计
            getStats() {
                const total = this.tasks.length;
                const completed = this.tasks.filter(task => task.completed).length;
                const pending = total - completed;
                const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

                const priorityStats = {
                    high: this.tasks.filter(task => task.priority === 'high').length,
                    medium: this.tasks.filter(task => task.priority === 'medium').length,
                    low: this.tasks.filter(task => task.priority === 'low').length,
                    none: this.tasks.filter(task => task.priority === 'none').length
                };

                return { total, completed, pending, progress, priorityStats };
            },

            // 恢复任务
            restoreTask(taskId) {
                const index = this.deletedTasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    const task = this.deletedTasks[index];
                    delete task.deletedAt; // 移除删除时间戳
                    this.tasks.unshift(task); 
                    this.deletedTasks.splice(index, 1);
                    this.saveData();
                    return task;
                }
                return null;
            },

            // 永久删除任务
            permanentDeleteTask(taskId) {
                const index = this.deletedTasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    this.deletedTasks.splice(index, 1);
                    this.saveData();
                    return true;
                }
                return false;
            },

            // 清空回收站
            emptyTrash() {
                const count = this.deletedTasks.length;
                this.deletedTasks = [];
                this.saveData();
                return count;
            },

            // 切换批量模式
            toggleBatchMode() {
                this.batchMode = !this.batchMode;
                this.selectedTasks.clear();
                return this.batchMode;
            },

            // 切换任务选择状态
            toggleTaskSelection(taskId) {
                if (this.selectedTasks.has(taskId)) {
                    this.selectedTasks.delete(taskId);
                } else {
                    this.selectedTasks.add(taskId);
                }
            },

            // 全选/取消全选
            selectAllTasks() {
                const tasks = this.getFilteredTasks();
                if (this.selectedTasks.size === tasks.length) {
                    this.selectedTasks.clear();
                } else {
                    tasks.forEach(task => this.selectedTasks.add(task.id));
                }
            },

            // 批量删除选中的任务
            batchDeleteTasks() {
                const selectedIds = Array.from(this.selectedTasks);
                const deletedCount = selectedIds.length;

                selectedIds.forEach(id => {
                    this.deleteTask(id);
                });

                this.selectedTasks.clear();
                return deletedCount;
            },

            // 切换主题
            toggleTheme() {
                this.darkMode = !this.darkMode;
                this.saveData();
                this.applyTheme();
            },

            // 应用主题
            applyTheme() {
                const body = document.body;
                const themeIcon = document.getElementById('themeIcon');

                if (this.darkMode) {
                    body.classList.add('dark');
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                } else {
                    body.classList.remove('dark');
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                }
            }
        };

        // DOM元素引用
        const elements = {
            taskForm: document.getElementById('taskForm'),
            taskTitle: document.getElementById('taskTitle'),
            taskDescription: document.getElementById('taskDescription'),
            taskPriority: document.getElementById('taskPriority'),
            taskDeadline: document.getElementById('taskDeadline'),
            editingTaskId: document.getElementById('editingTaskId'),
            formTitle: document.getElementById('formTitle'),
            submitBtnText: document.getElementById('submitBtnText'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            searchInput: document.getElementById('searchInput'),
            taskList: document.getElementById('taskList'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            confirmModal: document.getElementById('confirmModal'),
            confirmTitle: document.getElementById('confirmTitle'),
            confirmMessage: document.getElementById('confirmMessage'),
            confirmOk: document.getElementById('confirmOk'),
            confirmCancel: document.getElementById('confirmCancel'),
            notification: document.getElementById('notification'),
            notificationIcon: document.getElementById('notificationIcon'),
            notificationMessage: document.getElementById('notificationMessage'),
            statsBtn: document.getElementById('statsBtn'),
            trashBtn: document.getElementById('trashBtn'),
            trashCount: document.getElementById('trashCount'),
            progressBar: document.getElementById('progressBar'),
            trashModal: document.getElementById('trashModal'),
            trashList: document.getElementById('trashList'),
            trashItemCount: document.getElementById('trashItemCount'),
            emptyTrashBtn: document.getElementById('emptyTrashBtn'),
            closeTrashBtn: document.getElementById('closeTrashBtn'),
            toggleBatchModeBtn: document.getElementById('toggleBatchModeBtn'),
            selectAllBtn: document.getElementById('selectAllBtn'),
            batchDeleteBtn: document.getElementById('batchDeleteBtn'),
            themeToggle: document.getElementById('themeToggle'),
            themeIcon: document.getElementById('themeIcon'),
            helpBtn: document.getElementById('helpBtn'),
            helpModal: document.getElementById('helpModal'),
            closeHelpBtn: document.getElementById('closeHelpBtn')
        };

        // 工具函数 - 优化版本
        const Utils = {
            // 防抖函数
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // 节流函数
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            },

            // 格式化日期时间 - 优化版本
            formatDateTime(dateString) {
                if (!dateString) return '';

                const date = new Date(dateString);
                const now = new Date();
                const diff = date - now;

                // 缓存格式化选项
                if (!this._dateTimeOptions) {
                    this._dateTimeOptions = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                }

                const formatted = date.toLocaleString('zh-CN', this._dateTimeOptions);

                if (diff < 0) {
                    return `<span class="text-red-600">${formatted} (已过期)</span>`;
                } else if (diff < 24 * 60 * 60 * 1000) {
                    const hours = Math.floor(diff / (60 * 60 * 1000));
                    return `<span class="text-orange-600">${formatted} (剩余${hours}小时)</span>`;
                } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                    const days = Math.floor(diff / (24 * 60 * 60 * 1000));
                    return `<span class="text-yellow-600">${formatted} (剩余${days}天)</span>`;
                }

                return `<span class="text-gray-600">${formatted}</span>`;
            },

            // 格式化相对时间 - 优化版本
            formatRelativeTime(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;

                // 使用更高效的时间计算
                const minutes = Math.floor(diff / 60000);
                if (minutes < 1) return '刚刚';

                const hours = Math.floor(diff / 3600000);
                if (hours < 1) return `${minutes}分钟前`;

                const days = Math.floor(diff / 86400000);
                if (days < 1) return `${hours}小时前`;

                if (days < 30) return `${days}天前`;

                return new Date(timestamp).toLocaleDateString('zh-CN');
            },

            // 获取优先级标签
            getPriorityLabel(priority) {
                const labels = {
                    high: { text: '高', color: 'red' },
                    medium: { text: '中', color: 'yellow' },
                    low: { text: '低', color: 'green' },
                    none: { text: '无', color: 'gray' }
                };
                return labels[priority] || labels.none;
            },

            // 显示通知 - 优化版本
            showNotification(message, type = 'success') {
                // 清除之前的定时器
                if (this.notificationTimer) {
                    clearTimeout(this.notificationTimer);
                }

                const icons = {
                    success: 'fas fa-check-circle text-green-500',
                    error: 'fas fa-exclamation-circle text-red-500',
                    warning: 'fas fa-exclamation-triangle text-yellow-500',
                    info: 'fas fa-info-circle text-blue-500'
                };

                // 批量DOM操作
                const notification = elements.notification;
                requestAnimationFrame(() => {
                    elements.notificationIcon.className = icons[type] || icons.info;
                    elements.notificationMessage.textContent = message;
                    notification.classList.remove('hidden');
                });

                // 使用单例定时器
                this.notificationTimer = setTimeout(() => {
                    notification.classList.add('hidden');
                    this.notificationTimer = null;
                }, 3000);
            },

            // 显示确认对话框
            showConfirmDialog(title, message, onConfirm) {
                elements.confirmTitle.textContent = title;
                elements.confirmMessage.textContent = message;
                elements.confirmModal.classList.remove('hidden');

                const handleConfirm = () => {
                    elements.confirmModal.classList.add('hidden');
                    onConfirm();
                    cleanup();
                };

                const handleCancel = () => {
                    elements.confirmModal.classList.add('hidden');
                    cleanup();
                };

                const cleanup = () => {
                    elements.confirmOk.removeEventListener('click', handleConfirm);
                    elements.confirmCancel.removeEventListener('click', handleCancel);
                };

                elements.confirmOk.addEventListener('click', handleConfirm);
                elements.confirmCancel.addEventListener('click', handleCancel);
            },

            // 设置最小日期时间为当前时间
            setMinDateTime() {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                elements.taskDeadline.min = now.toISOString().slice(0, 16);
            },

            // 格式化剩余保存时间
            formatRemainingTime(deletedAt) {
                const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                const expiredTime = deletedAt + thirtyDays;
                const now = Date.now();
                const remaining = expiredTime - now;

                if (remaining <= 0) {
                    return '<span class="text-red-600 font-medium">已过期</span>';
                }

                const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
                const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));

                if (days > 0) {
                    return `<span class="text-orange-600">剩余 ${days} 天 ${hours} 小时</span>`;
                } else if (hours > 0) {
                    return `<span class="text-red-600">剩余 ${hours} 小时</span>`;
                } else {
                    return '<span class="text-red-600 font-medium">即将过期</span>';
                }
            }
        };

        // 回收站渲染器
        const TrashRenderer = {
            // 渲染单个回收站项目
            renderTrashItem(task) {
                const priority = Utils.getPriorityLabel(task.priority);
                const deadlineInfo = Utils.formatDateTime(task.deadline);
                const remainingTime = Utils.formatRemainingTime(task.deletedAt);

                return `
                    <div class="bg-white border border-red-200 rounded-lg p-4 opacity-90 hover:opacity-100 transition-opacity slide-in" data-trash-task-id="${task.id}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3 flex-1">
                                <div class="mt-1">
                                    <i class="fas fa-trash-alt text-red-500"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900 ${task.completed ? 'line-through opacity-60' : ''}">${this.escapeHtml(task.title)}</h3>
                                    ${task.description ? `<p class="text-sm text-gray-600 mt-1">${this.escapeHtml(task.description)}</p>` : ''}
                                    <div class="flex flex-wrap items-center gap-2 mt-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${priority.color}-100 text-${priority.color}-800">
                                            <i class="fas fa-flag mr-1"></i>
                                            ${priority.text}优先级
                                        </span>
                                        ${task.completed ? `
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check mr-1"></i>
                                                已完成
                                            </span>
                                        ` : ''}
                                        ${task.deadline ? `
                                            <span class="inline-flex items-center text-xs text-gray-500">
                                                <i class="fas fa-clock mr-1"></i>
                                                ${deadlineInfo}
                                            </span>
                                        ` : ''}
                                        <span class="inline-flex items-center text-xs text-gray-400">
                                            删除于 ${Utils.formatRelativeTime(task.deletedAt)}
                                        </span>
                                    </div>
                                    <div class="mt-2">
                                        <span class="inline-flex items-center text-xs">
                                            <i class="fas fa-hourglass-half mr-1"></i>
                                            ${remainingTime}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button class="restore-btn text-green-600 hover:text-green-800 transition-colors" data-trash-task-id="${task.id}" title="恢复">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button class="permanent-delete-btn text-red-600 hover:text-red-800 transition-colors" data-trash-task-id="${task.id}" title="永久删除">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            // 渲染回收站列表
            renderTrashList() {
                const deletedTasks = AppState.deletedTasks;

                // 更新回收站项目计数
                elements.trashItemCount.textContent = `${deletedTasks.length} 个项目`;

                if (deletedTasks.length === 0) {
                    elements.trashList.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-trash-alt text-5xl mb-4 opacity-50"></i>
                            <p class="text-lg">回收站是空的</p>
                            <p class="text-sm mt-2">删除的任务会出现在这里，并在30天后自动清理</p>
                        </div>
                    `;
                    return;
                }

                // 按删除时间排序（新删除的在前）
                const sortedTasks = [...deletedTasks].sort((a, b) => b.deletedAt - a.deletedAt);

                elements.trashList.innerHTML = sortedTasks.map(task => this.renderTrashItem(task)).join('');
                this.attachTrashEventListeners();
            },

            // 附加回收站事件监听器 - 优化版本（使用事件委托）
            attachTrashEventListeners() {
                // 移除之前的事件监听器（如果存在）
                if (this.trashListHandler) {
                    elements.trashList.removeEventListener('click', this.trashListHandler);
                }

                // 事件委托处理器
                this.trashListHandler = (e) => {
                    // 恢复按钮
                    const restoreBtn = e.target.closest('.restore-btn');
                    if (restoreBtn) {
                        const taskId = restoreBtn.dataset.trashTaskId;
                        const task = AppState.deletedTasks.find(t => t.id === taskId);
                        if (task) {
                            Utils.showConfirmDialog(
                                '确认恢复',
                                `您确定要恢复任务"${task.title}"吗？`,
                                () => {
                                    AppState.restoreTask(taskId);
                                    Utils.showNotification('任务已恢复', 'success');
                                    this.renderTrashList();
                                    TaskRenderer.renderTaskList();
                                    updateStats();
                                    updateTrashCount();
                                }
                            );
                        }
                        return;
                    }

                    // 永久删除按钮
                    const deleteBtn = e.target.closest('.permanent-delete-btn');
                    if (deleteBtn) {
                        const taskId = deleteBtn.dataset.trashTaskId;
                        const task = AppState.deletedTasks.find(t => t.id === taskId);
                        if (task) {
                            Utils.showConfirmDialog(
                                '确认永久删除',
                                `您确定要永久删除任务"${task.title}"吗？此操作无法撤销！`,
                                () => {
                                    AppState.permanentDeleteTask(taskId);
                                    Utils.showNotification('任务已永久删除', 'warning');
                                    this.renderTrashList();
                                    updateTrashCount();
                                }
                            );
                        }
                    }
                };

                // 添加事件监听器
                elements.trashList.addEventListener('click', this.trashListHandler);
            },

            // HTML转义
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
        };

        // 任务渲染器
        const TaskRenderer = {
            // 渲染单个任务项
            renderTask(task) {
                const priority = Utils.getPriorityLabel(task.priority);
                const deadlineInfo = Utils.formatDateTime(task.deadline);
                const isSelected = AppState.selectedTasks.has(task.id);

                return `
                    <div class="task-item bg-white border rounded-lg p-4 priority-${task.priority} ${task.completed ? 'completed' : ''} ${isSelected ? 'ring-2 ring-blue-500' : ''} ${AppState.batchMode ? 'hover:bg-gray-50' : ''} slide-in" data-task-id="${task.id}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3 flex-1">
                                ${AppState.batchMode ? `
                                    <input
                                        type="checkbox"
                                        ${isSelected ? 'checked' : ''}
                                        class="batch-checkbox mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                        data-task-id="${task.id}"
                                    >
                                ` : `
                                    <input
                                        type="checkbox"
                                        ${task.completed ? 'checked' : ''}
                                        class="task-checkbox mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                        data-task-id="${task.id}"
                                    >
                                `}
                                <div class="flex-1">
                                    <h3 class="task-title font-medium text-gray-900 ${isSelected ? 'text-blue-700' : ''}">${this.escapeHtml(task.title)}</h3>
                                    ${task.description ? `<p class="text-sm text-gray-600 mt-1">${this.escapeHtml(task.description)}</p>` : ''}
                                    <div class="flex flex-wrap items-center gap-2 mt-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${priority.color}-100 text-${priority.color}-800">
                                            <i class="fas fa-flag mr-1"></i>
                                            ${priority.text}优先级
                                        </span>
                                        ${task.deadline ? `
                                            <span class="inline-flex items-center text-xs text-gray-500">
                                                <i class="fas fa-clock mr-1"></i>
                                                ${deadlineInfo}
                                            </span>
                                        ` : ''}
                                        <span class="inline-flex items-center text-xs text-gray-400">
                                            创建于 ${Utils.formatRelativeTime(task.createdAt)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                ${!AppState.batchMode ? `
                                    <button class="edit-btn text-blue-600 hover:text-blue-800 transition-colors" data-task-id="${task.id}" title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-btn text-red-600 hover:text-red-800 transition-colors" data-task-id="${task.id}" title="删除">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            // 渲染任务列表 - 优化版本
            renderTaskList() {
                const tasks = AppState.getFilteredTasks();

                // 使用DocumentFragment进行批量DOM操作
                const fragment = document.createDocumentFragment();

                if (tasks.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'text-center py-8 text-gray-500';
                    emptyDiv.innerHTML = `
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>${AppState.searchTerm ? '没有找到匹配的任务' : '暂无任务，开始添加您的第一个任务吧！'}</p>
                    `;
                    fragment.appendChild(emptyDiv);
                } else {
                    // 批量创建任务元素
                    tasks.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.innerHTML = this.renderTask(task);
                        fragment.appendChild(taskDiv.firstElementChild);
                    });
                }

                // 一次性更新DOM
                requestAnimationFrame(() => {
                    elements.taskList.innerHTML = '';
                    elements.taskList.appendChild(fragment);
                    this.attachTaskEventListeners();
                });
            },

            // 附加任务事件监听器 - 优化版本（使用事件委托）
            attachTaskEventListeners() {
                // 移除之前的事件监听器（如果存在）
                if (this.taskListHandler) {
                    elements.taskList.removeEventListener('click', this.taskListHandler);
                    elements.taskList.removeEventListener('change', this.taskChangeHandler);
                }

                // 事件委托处理器
                this.taskListHandler = (e) => {
                    const taskItem = e.target.closest('.task-item');
                    if (!taskItem) return;

                    const taskId = taskItem.dataset.taskId;

                    // 编辑按钮
                    if (e.target.closest('.edit-btn')) {
                        editTask(taskId);
                        return;
                    }

                    // 删除按钮
                    if (e.target.closest('.delete-btn')) {
                        const task = AppState.tasks.find(t => t.id === taskId);
                        if (task) {
                            Utils.showConfirmDialog(
                                '确认删除',
                                `您确定要将任务"${task.title}"移至回收站吗？`,
                                () => {
                                    AppState.deleteTask(taskId);
                                    Utils.showNotification('任务已移至回收站', 'warning');
                                    this.renderTaskList();
                                    updateStats();
                                    updateTrashCount();
                                }
                            );
                        }
                        return;
                    }

                    // 批量模式下的任务点击
                    if (AppState.batchMode && e.target.type !== 'checkbox' && !e.target.closest('button')) {
                        const checkbox = taskItem.querySelector('.batch-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            AppState.toggleTaskSelection(taskId);
                            this.renderTaskList();
                            updateBatchButtons();
                        }
                    }
                };

                this.taskChangeHandler = (e) => {
                    const taskItem = e.target.closest('.task-item');
                    if (!taskItem) return;

                    const taskId = taskItem.dataset.taskId;

                    // 任务完成复选框
                    if (e.target.classList.contains('task-checkbox')) {
                        const task = AppState.toggleTask(taskId);
                        if (task) {
                            Utils.showNotification(
                                task.completed ? '任务已完成！' : '任务标记为未完成',
                                task.completed ? 'success' : 'info'
                            );
                            this.renderTaskList();
                            updateStats();
                        }
                        return;
                    }

                    // 批量选择复选框
                    if (e.target.classList.contains('batch-checkbox')) {
                        AppState.toggleTaskSelection(taskId);
                        this.renderTaskList();
                        updateBatchButtons();
                    }
                };

                // 添加事件监听器
                elements.taskList.addEventListener('click', this.taskListHandler);
                elements.taskList.addEventListener('change', this.taskChangeHandler);
            },

            // HTML转义
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
        };

        // 更新统计信息
        function updateStats() {
            const stats = AppState.getStats();

            // 更新背景文字
            document.getElementById('totalTasksBg').textContent = stats.total;
            document.getElementById('completedTasksBg').textContent = stats.completed;
            document.getElementById('pendingTasksBg').textContent = stats.pending;
            document.getElementById('progressTextBg').textContent = `${stats.progress}%`;

            // 更新进度条内文字
            document.getElementById('totalTasks').textContent = stats.total;
            document.getElementById('completedTasks').textContent = stats.completed;
            document.getElementById('pendingTasks').textContent = stats.pending;
            document.getElementById('progressText').textContent = `${stats.progress}%`;

            // 更新进度条宽度
            elements.progressBar.style.width = `${stats.progress}%`;

            // 当进度条有进度时，显示白色文字覆盖层
            const progressBarText = document.getElementById('progressBarText');
            if (stats.progress > 0) {
                progressBarText.style.display = 'inline';
            } else {
                progressBarText.style.display = 'none';
            }
        }

        // 更新回收站计数
        function updateTrashCount() {
            const count = AppState.deletedTasks.length;
            if (count > 0) {
                elements.trashCount.textContent = count;
                elements.trashCount.classList.remove('hidden');
            } else {
                elements.trashCount.classList.add('hidden');
            }
        }

        // 编辑任务
        function editTask(taskId) {
            const task = AppState.tasks.find(t => t.id === taskId);
            if (!task) return;

            AppState.editingTask = task;
            elements.editingTaskId.value = task.id;
            elements.taskTitle.value = task.title;
            elements.taskDescription.value = task.description || '';
            elements.taskPriority.value = task.priority;
            elements.taskDeadline.value = task.deadline || '';

            elements.formTitle.textContent = '编辑任务';
            elements.submitBtnText.textContent = '更新任务';
            elements.cancelEditBtn.classList.remove('hidden');

            // 滚动到表单
            elements.taskForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            elements.taskTitle.focus();
        }

        // 取消编辑
        function cancelEdit() {
            AppState.editingTask = null;
            elements.taskForm.reset();
            elements.editingTaskId.value = '';
            elements.formTitle.textContent = '添加新任务';
            elements.submitBtnText.textContent = '添加任务';
            elements.cancelEditBtn.classList.add('hidden');
        }

        // 表单提交处理
        function handleFormSubmit(e) {
            e.preventDefault();

            const taskData = {
                title: elements.taskTitle.value.trim(),
                description: elements.taskDescription.value.trim(),
                priority: elements.taskPriority.value,
                deadline: elements.taskDeadline.value
            };

            // 验证截止日期
            if (taskData.deadline) {
                const deadline = new Date(taskData.deadline);
                const now = new Date();
                if (deadline < now) {
                    Utils.showNotification('截止日期不能早于当前时间', 'error');
                    return;
                }
            }

            if (AppState.editingTask) {
                // 更新任务
                AppState.updateTask(AppState.editingTask.id, taskData);
                Utils.showNotification('任务更新成功', 'success');
                cancelEdit();
            } else {
                // 添加新任务
                AppState.addTask(taskData);
                Utils.showNotification('任务添加成功', 'success');
                elements.taskForm.reset();
            }

            TaskRenderer.renderTaskList();
            updateStats();
        }

        // 搜索处理 - 优化版本（防抖）
        const handleSearch = Utils.debounce(() => {
            AppState.searchTerm = elements.searchInput.value.trim();
            TaskRenderer.renderTaskList();
        }, 300);

        // 过滤处理
        function handleFilter(e) {
            // 更新按钮样式
            elements.filterBtns.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            });

            e.target.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            e.target.classList.add('bg-blue-600', 'text-white');

            AppState.currentFilter = e.target.dataset.filter;
            TaskRenderer.renderTaskList();
        }

        // 显示回收站
        function showTrash() {
            elements.trashModal.classList.remove('hidden');
            TrashRenderer.renderTrashList();
        }

        // 关闭回收站
        function closeTrash() {
            elements.trashModal.classList.add('hidden');
        }

        // 清空回收站
        function emptyTrash() {
            const deletedCount = AppState.deletedTasks.length;
            if (deletedCount === 0) {
                Utils.showNotification('回收站已经是空的', 'info');
                return;
            }

            Utils.showConfirmDialog(
                '确认清空回收站',
                `您确定要清空回收站吗？这将永久删除 ${deletedCount} 个任务，此操作无法撤销！`,
                () => {
                    const count = AppState.emptyTrash();
                    Utils.showNotification(`已清空回收站，永久删除了 ${count} 个任务`, 'warning');
                    TrashRenderer.renderTrashList();
                    updateTrashCount();
                }
            );
        }

        // 显示统计
        function showStats() {
            const stats = AppState.getStats();
            const message = `
                总任务: ${stats.total} |
                已完成: ${stats.completed} |
                进行中: ${stats.pending} |
                完成率: ${stats.progress}%
            `;
            Utils.showNotification(message, 'info');
        }

        // 更新批量操作按钮状态
        function updateBatchButtons() {
            const tasks = AppState.getFilteredTasks();
            const hasTasks = tasks.length > 0;
            const hasSelected = AppState.selectedTasks.size > 0;

            if (AppState.batchMode) {
                elements.selectAllBtn.classList.remove('hidden');
                elements.batchDeleteBtn.classList.remove('hidden');

                // 更新全选按钮文本
                if (AppState.selectedTasks.size === tasks.length) {
                    elements.selectAllBtn.innerHTML = '<i class="fas fa-square mr-1"></i>取消全选';
                } else {
                    elements.selectAllBtn.innerHTML = '<i class="fas fa-check-square mr-1"></i>全选';
                }

                // 更新批量删除按钮状态
                elements.batchDeleteBtn.disabled = !hasSelected;
                if (hasSelected) {
                    elements.batchDeleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    elements.batchDeleteBtn.innerHTML = `<i class="fas fa-trash mr-1"></i>批量删除 (${AppState.selectedTasks.size})`;
                } else {
                    elements.batchDeleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    elements.batchDeleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i>批量删除';
                }
            } else {
                elements.selectAllBtn.classList.add('hidden');
                elements.batchDeleteBtn.classList.add('hidden');
            }
        }

        // 切换批量模式
        function toggleBatchMode() {
            const newMode = AppState.toggleBatchMode();

            if (newMode) {
                elements.toggleBatchModeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                elements.toggleBatchModeBtn.classList.add('bg-blue-600', 'text-white');
                elements.toggleBatchModeBtn.innerHTML = '<i class="fas fa-times mr-1"></i>退出批量';
            } else {
                elements.toggleBatchModeBtn.classList.add('bg-gray-100', 'text-gray-700');
                elements.toggleBatchModeBtn.classList.remove('bg-blue-600', 'text-white');
                elements.toggleBatchModeBtn.innerHTML = '<i class="fas fa-tasks mr-1"></i>批量操作';
            }

            TaskRenderer.renderTaskList();
            updateBatchButtons();
        }

        // 全选/取消全选
        function selectAll() {
            AppState.selectAllTasks();
            TaskRenderer.renderTaskList();
            updateBatchButtons();
        }

        // 批量删除
        function batchDelete() {
            const selectedCount = AppState.selectedTasks.size;
            if (selectedCount === 0) {
                Utils.showNotification('请先选择要删除的任务', 'warning');
                return;
            }

            Utils.showConfirmDialog(
                '确认批量删除',
                `您确定要删除选中的 ${selectedCount} 个任务吗？这些任务将被移至回收站。`,
                () => {
                    const deletedCount = AppState.batchDeleteTasks();
                    Utils.showNotification(`已将 ${deletedCount} 个任务移至回收站`, 'warning');
                    TaskRenderer.renderTaskList();
                    updateStats();
                    updateTrashCount();
                    updateBatchButtons();
                }
            );
        }

        function showHelp() {
            elements.helpModal.classList.remove('hidden');
        }

        function closeHelp() {
            elements.helpModal.classList.add('hidden');
        }

        // 初始化应用
        function initApp() {
            AppState.loadData();

            // 设置最小日期时间
            Utils.setMinDateTime();

            // 应用主题
            AppState.applyTheme();

            // 渲染初始界面
            TaskRenderer.renderTaskList();
            updateStats();
            updateTrashCount();

            // 设置初始过滤按钮样式
            elements.filterBtns[0].classList.add('bg-blue-600', 'text-white');
            elements.filterBtns[0].classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');

            // 事件监听器
            elements.taskForm.addEventListener('submit', handleFormSubmit);
            elements.cancelEditBtn.addEventListener('click', cancelEdit);
            elements.searchInput.addEventListener('input', handleSearch);
            elements.themeToggle.addEventListener('click', () => AppState.toggleTheme());
            elements.filterBtns.forEach(btn => {
                btn.addEventListener('click', handleFilter);
            });
            elements.trashBtn.addEventListener('click', showTrash);
            elements.statsBtn.addEventListener('click', showStats);

            // 批量操作事件监听器
            elements.toggleBatchModeBtn.addEventListener('click', toggleBatchMode);
            elements.selectAllBtn.addEventListener('click', selectAll);
            elements.batchDeleteBtn.addEventListener('click', batchDelete);

            // 帮助提示事件监听器
            elements.helpBtn.addEventListener('click', showHelp);
            elements.closeHelpBtn.addEventListener('click', closeHelp);

            // 回收站事件监听器
            elements.closeTrashBtn.addEventListener('click', closeTrash);
            elements.emptyTrashBtn.addEventListener('click', emptyTrash);

            // 点击回收站模态框外部关闭
            elements.trashModal.addEventListener('click', (e) => {
                if (e.target === elements.trashModal) {
                    closeTrash();
                }
            });

            // 点击帮助模态框外部关闭
            elements.helpModal.addEventListener('click', (e) => {
                if (e.target === elements.helpModal) {
                    closeHelp();
                }
            });

            // ESC键关闭模态框
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!elements.trashModal.classList.contains('hidden')) {
                        closeTrash();
                    } else if (!elements.helpModal.classList.contains('hidden')) {
                        closeHelp();
                    }
                }
            });

            // 定时器管理 - 优化版本（合并定时器）
            const TimerManager = {
                timers: [],

                addTimer(callback, interval) {
                    const timerId = setInterval(callback, interval);
                    this.timers.push(timerId);
                    return timerId;
                },

                clearAllTimers() {
                    this.timers.forEach(timerId => clearInterval(timerId));
                    this.timers = [];
                }
            };

            // 合并定时器逻辑，减少定时器数量
            TimerManager.addTimer(() => {
                AppState.saveData();
                AppState.cleanExpiredDeletedTasks();
                updateTrashCount();

                // 如果回收站模态框打开，更新剩余时间显示
                if (!elements.trashModal.classList.contains('hidden')) {
                    TrashRenderer.renderTrashList();
                }
            }, 30000); // 每30秒执行一次，包含之前的1分钟逻辑

            Utils.showNotification('时间盒子已准备就绪', 'success');
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>